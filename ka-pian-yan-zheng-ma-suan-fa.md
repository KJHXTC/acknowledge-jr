# 卡片验证码算法

磁条卡时期，发卡行在发卡时使用的算法，用于后期持卡人刷卡时鉴别卡片真伪的用途。

不同卡组织对这个验证码的称谓都不同，但算法过程和原理相似，参见各卡组织规范

#### CVN\(Card Verification Number\)  银联国密

> 【中国银联银行卡交换系统技术规范第 4 部分 数据安全传输控制规范Q/CUP 006.4-2016 A.2】

密钥：128bits

算法：SM4

输入：

* 账号 PAN 不做任何处理 一般银行卡为 16位/19位的数字
* 有效期 4位数字
* 服务码 3位数字

描述：

1. 将PAN、 有效期、服务码依次拼接
2. 如果拼接不足 128Bits 数据则填充 bit0 得到待计算的块 BlockA
3. 使用密钥对数据进行SM4加密 SM4\(CVK, BlockA\)，得到密文块 BlockB并展开为HEX
4. 将3中展开的HEX 提取数字字符\(0-9\)， 然后提取 字符\(A-F\)并减10 得到 数字即 `A -> 0` `B -> 1` ... `F -> 5` 将数字字符依次写入缓存
5. 从缓存中从左开始，提取3位 数字即 CVN

输出： 3位 CVN

#### CVN\(Card Verification Number\)  银联国际

> CVN
>
> CVN2【卡片验证码2\(CVN2\)技术规范 Q/CUP 015-2005】
>
> CVN2 是用于电话、网络交易时用户输入身份信息（卡片背面那个3位数字）

CVN2 即卡片背面的3位数字，算法与 CVN相同，但服务码为常量 `000`

#### CVV\(Card Verification Value\)

> VISA CVV CVV2【Payment Technology Standards Manual - Chapter 2 Card Verification Value \(CVV and iCVV\) 2004】

VISA的CVV与银联CVN算法一致。

VISA的Chip iCVV，服务码是常量 `999` 芯片卡

VISA的CVV2 服务码常量是 `000` 用户输入的格式可能是 MM/YY 而非 YY/MM ，计算需要保持 YYMM格式

#### CVC\(Card Validation Code\)

> MasterCard CVC/CVC2 万事达 卡片校验码

#### CSC\(Card Security Code\)

> AmericanExpress CSC5/CSC4/CSC3 即美国运通安全码

美国运通卡使用3个卡安全码（CSC）。其分别为：

* 3位的CSC－位于签名面板上     类似于 CVN2
* 4位的CSC－位于卡的前面
* 5位的CSC－位于磁带上             类似于 CVN

> CSC码规则与CVN相似。只是提取的过程不同，获得3、4和5位的安全码。其具体实现包括三个步骤：
>
> 1．为加密组成一个帐号块
>
> 2．用DES算法加密该块
>
> 3．提取CSC值

密钥： 128Bits

算法：DESede

输入：

* 账号 PAN ，去除校验位，右对齐，截取后12位账号，如果不足左侧补0
* 有效期 YYMM

描述：

将 4位有效期和12位处理后的PAN拼接构成 16 位的块 即 DES block 64bits

使用密钥对这个块加密，得密文，那么如何提取CSC值

扫描DES运算之后的值，进行提取以获得3个CSC值。

1、 通过扫描DES输出的串，并提取其中的数字位得到一个CSC串。

2、 如果CSC串的长度小于12位，则重新扫描DES输出串，并通过以下过程将字符转换数字：

​ i. 转换字符为数字（A=1，B=2，C=3，D=4，E=5，F=6）。

​ ii. 为了提供一个更好的数字分布，对选定的数字加上5。如果所提取的字母在串的第5位之后，则对该字母所对应的数字值加上5（模10）。

​ iii. 将该数字值附加到CSC串后。

​ iv. 或者转换完全部的字母，或者当CSC串的字符个数为12之后退出。

3、 这样在CSC串中将至少有12位。

4、 下面的值将被设置：

* 5位的CSC－最前面的5位（第1，2，3，4，5位）
* 4位的CSC－随后的4位（第6，7，8，9位）
* 3位的CSC－随后的3位（第10，11，12位）

5、 如果任一CSC为全0，则将安全码用下列值代替：

* 5位的CSC－`42880`
* 4位的CSC－`2450`
* 3位的CSC－`127`

**示例**

下面的信息在该例程中使用：

|  |
| :--- |
| 帐号：37123456789012 |
| 有效期：9912 |
| DES密钥：1234567890ABCDEF |
| X’…’：指定为一个十六进制值 |
| C’…’：指定为一个字符/可打印的信息 |

**第一步：组成帐号块**

建立一个12位的域－存储15位帐号域中的第3－14位（去除37和校验位）

​ 域：C’123456789012’

​ 在12位前加上有效期（YYMM），组成一个16字符的域

​ 域：C’9912123456789012’

创建一个64比特的域：X’9912123456789012’

**第二步：加密帐号块**

使用上述的密钥，DES运算之后将返回以下的被加密块

​ E7095B441A172830

**第三步：提取卡安全代码值**

扫描DES结果，得到：

​ 5位CSC = 70954

​ 4位CSC = 4117

​ 3位CSC = 283

#### 扩展 卡片磁道信息

> 磁道信息，参见【银行卡磁条信息格式和使用规范 GB/T 19584-2004】 包含 了3磁道
>
> 在发卡阶段需要计算CVN和CVN2 用于制卡（磁道信息以及卡片信息）

1. 第一磁道 最大 79 字节信息，包含（这里不关注顺序）
   * 主账号（13-19位银行账号数字）
   * 失效日期 4位数字（YYMM）
   * 服务代码 3位数字
   * 持卡人姓名（2-26）
2. 第二磁道 最大40字节信息， 用于磁卡交易包含
   * 主账号（13-19位银行账号数字）
   * 失效日期 4位数字（YYMM）
   * 服务代码 3位数字
   * 附件数据 3位数字（即CVN）
3. 第三磁道 最大 107字节，

   ```text
    主要包含交易状态等信息，这里不做过多说明。

    卡片CVN计算方法在附录中也有说明，核心元素为 二磁道的4个元素。
   ```

由于磁条卡中的磁道信息都直接存储在磁道中，如果有一个读取磁道的设备就可以将这些信息都读取出来，同时某个不法分子动下心思，将这些信息留存然后写入到另一张空白的磁条卡，那么他将有一个一模一样的卡片这样就存在很大的隐患，新闻上也有不少此类报道（POS设备、ATM设备）都是一些不法之徒利用一些媒介先获取词条的信息然后利用远程摄像头等设备记录输入的PIN密码然后利用伪造的卡片和记录的密码窃取用户的钱财。正是磁条卡的不安全性，所以目前各大卡组织都在推广（强制要求使用）IC卡（智能芯片卡）作为持卡人身份鉴别卡片。

